rules:
  - id: "2.6.1.1"
    title: "Content-Type Header Requirement"
    message: "Content-Type must be set to application/json;charset=UTF-8 if the body is present."
    option: Conditional
    location: paths
    element: 
      - requestHeaders
    call: 
      function: headerCheck
      functionParams: 
        header: "Content-Type"
        default_value: "application/json;charset=UTF-8"
        type: "string"
        allowed_values: 
          - "application/json;charset=UTF-8"
          - "application/json;charset=utf-8"
          - "application/json;charset=\"utf-8\""
          - "application/octet-stream"
          - "multipart/form-data"
          - "application/bson"
        condition: 
          all:
            - property: "requestBody",
              exists: true
            - property: "method", 
              in: ["get", "head", "post", "put", "delete", "patch"]
        max_length_condition:
          header_max_length: 32768  # 32 KB
          http_header_max_size: 65536  # 64 KB
    severity: "critical"
 
  - id: "2.6.1.2"
    title: "X-SDK-Date Header Requirement"
    message: "X-SDK-Date must follow format YYYYMMDD'T'HHMMSS'Z' if AK/SK authentication is used."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call: 
      function: headerCheck
      functionParams:
        header: "X-SDK-Date"
        regex: "^[0-9]{8}T[0-9]{6}Z$"
        type: "string"
        default_value: null
        condition:
          all:
            - property: "authenticationMethod" #in case no PKIToken is used 
              equals: "AK/SK"
            - property: "requestHeaders.X-SDK-Date"
              exists: true
            - property: "requestHeaders.X-SDK-Date"
              validate_with: "system_gmt_time"
        max_length_condition:
          header_max_length: 32768
          http_header_max_size: 65536
    severity: "critical"
  
  - id: "2.6.1.3"
    title: "Authorization Header Requirement"
    message: "Authorization header must be present if AK/SK authentication is used."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "Authorization"
        type: "string"
        default_value: null
        condition:
          all: 
          - property: "authenticationMethod" #in case no PKIToken is used
            equals: "AK/SK"
          - property: "requestHeaders.Authorization"
            exists: true
          - property: "requestHeaders.Authorization"
            matches: "^[a-zA-Z0-9+/=]+$"  
        max_length_condition:
          header_max_length: 32768
          http_header_max_size: 65536              
      #alternativeCondition:
      #  all:
      #    - property: "authenticationMethod"
      #      equals: "IAM 5.0"
      #    - property: "requestHeaders.Authorization"
      #      exists: true
      #      description: "Authorization header is used for JWT authentication in IAM 5.0"
    severity: "critical"

  - id: "2.6.1.5"
    title: "X-Auth-Token Header Requirement"
    message: "X-Auth-Token must be present if PKIToken authentication is used."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "X-Auth-Token"
        type: "string"
        default_value: null
        condition:
          property: "authenticationMethod"
          equals: "PKIToken"
        max_length_condition:
          header_max_length: 32768
          http_header_max_size: 65536
    severity: "critical"

  - id: "2.6.1.4"
    title: "Host Header Requirement"
    message: "Host header must be present and contain the requested server information, including hostname and optional port."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "Host"
        type: "string"
        default_value: "hostname:443"
        condition:
          all:
            - property: "authenticationMethod"
              equals: "AK/SK"
            - property: "requestHeaders.Host"
              exists: true
        max_length_condition:
          header_max_length: 32768
          http_header_max_size: 65536
    severity: "critical"
  
  - id: "2.6.1.6"
    title: "X-Project-Id Header Requirement"
    message: "X-Project-Id must be present if the API request uses AK/SK authentication in the DeC or multi-project scenario."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "X-Project-Id"
        type: "string"
        default_value: null
        condition:
          property: "authenticationMethod"
          equals: "AK/SK"
        additional_condition:
            property: "projectScenario"
            in: ["DeC", "multi-project"]
        max_length_condition:
          header_max_length: 32768
          http_header_max_size: 65536
    severity: "critical"

  - id: "2.6.1.7"
    title: "X-Domain-Id Header Requirement"
    message: "X-Domain-Id is optional for global services authenticated by IAM 3.0."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "X-Domain-Id"
        type: "string"
        default_value: null
        condition:
          property: "authenticationMethod"
          equals: "IAM 3.0"
        max_length_condition:
          header_max_length: 32768  
          http_header_max_size: 65536  
    severity: "warning"

  - id: "2.6.1.8"
    title: "X-Security-Token Header Requirement"
    message: "X-Security-Token is mandatory when using temporary AK/SK authentication for signature."
    option: Conditional
    location: paths
    element:
      - requestHeaders
    call:
      function: headerCheck
      functionParams:
        header: "X-Security-Token"
        type: "string"
        default_value: null
        condition:
          property: "authenticationMethod"
          equals: "temporary AK/SK"
        max_length_condition:
          header_max_length: 32768  
          http_header_max_size: 65536  
    severity: "critical"


